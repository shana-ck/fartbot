/// <reference types="node" resolution-mode="require"/>
import type { ComAtprotoSyncSubscribeRepos } from "@atproto/api";
import { cborToLexRecord } from "@atproto/repo";
import type { CID } from "multiformats";
import { EventEmitter } from "node:events";
import * as WS from "ws";
/**
 * Options for the Firehose class.
 */
export interface FirehoseOptions {
    /**
     * The cursor to listen from. If not provided, the firehose will start from the latest event.
     */
    cursor?: string;
    /**
     * How frequently to update the stored cursor, in milliseconds.
     * @default 5000
     */
    setCursorInterval?: number;
}
export declare class Firehose extends EventEmitter {
    relay: string;
    private options;
    /** WebSocket connection to the relay. */
    ws?: WS.WebSocket;
    /** The current cursor. */
    cursor: string;
    private cursorInterval?;
    /**
     * Creates a new Firehose instance.
     * @param relay The relay to connect to.
     * @param options Optional configuration.
     */
    constructor(relay?: string, options?: FirehoseOptions);
    /**
     * Opens a WebSocket connection to the relay.
     */
    start(): void;
    /**
     * Closes the WebSocket connection.
     */
    close(): void;
    /** Emitted when the connection is opened. */
    on(event: "open", listener: () => void): this;
    /** Emitted when the connection is closed. */
    on(event: "close", listener: (cursor: string) => void): this;
    /** Emitted when an error occurs while handling a message. */
    on(event: "error", listener: ({ cursor, error }: {
        cursor: string;
        error: Error;
    }) => void): this;
    /** Emitted when an error occurs within the websocket. */
    on(event: "websocketError", listener: ({ cursor, error }: {
        cursor: string;
        error: unknown;
    }) => void): this;
    /** Emitted when an unknown message is received. */
    on(event: "unknown", listener: (message: unknown) => void): this;
    /**
     * Represents an update of an account's handle, or transition to/from invalid state.
     * NOTE: Will be deprecated in favor of #identity.
     */
    on(event: "handle", listener: (message: ComAtprotoSyncSubscribeRepos.Handle & {
        $type: "com.atproto.sync.subscribeRepos#handle";
    }) => void): this;
    /**
     * Represents an account moving from one PDS instance to another.
     * NOTE: not implemented; account migration uses #identity instead
     */
    on(event: "migrate", listener: (message: ComAtprotoSyncSubscribeRepos.Migrate & {
        $type: "com.atproto.sync.subscribeRepos#migrate";
    }) => void): this;
    /**
     * Indicates that an account has been deleted.
     * NOTE: may be deprecated in favor of #identity or a future #account event
     */
    on(event: "tombstone", listener: (message: ComAtprotoSyncSubscribeRepos.Tombstone & {
        $type: "com.atproto.sync.subscribeRepos#tombstone";
    }) => void): this;
    /**
     * Represents a change to an account's identity.
     * Could be an updated handle, signing key, or pds hosting endpoint.
     */
    on(event: "identity", listener: (message: ComAtprotoSyncSubscribeRepos.Identity & {
        $type: "com.atproto.sync.subscribeRepos#identity";
    }) => void): this;
    /** Represents a commit to a user's repository. */
    on(event: "commit", listener: (message: ParsedCommit) => void): this;
    /** An informational message from the relay. */
    on(event: "info", listener: (message: ComAtprotoSyncSubscribeRepos.Info & {
        $type: "com.atproto.sync.subscribeRepos#info";
    }) => void): this;
    private parseMessage;
    /** Sets the cursor once every `setCursorInterval` milliseconds. */
    private setCursor;
}
/**
 * Represents a record in a repository. An object with string keys & properties of any type.
 */
export type RepoRecord = ReturnType<typeof cborToLexRecord>;
/**
 * Represents a `create` or `update` repository operation.
 */
export interface CreateOrUpdateOp {
    action: "create" | "update";
    /** The record's path in the repository. */
    path: string;
    /** The record's CID. */
    cid: CID;
    /** The record itself. */
    record: RepoRecord;
}
/**
 * Represents a `delete` repository operation.
 */
export interface DeleteOp {
    action: "delete";
    /** The record's path in the repository. */
    path: string;
}
/** A repository operation. */
export type RepoOp = CreateOrUpdateOp | DeleteOp;
/**
 * Represents an update of repository state.
 */
export interface ParsedCommit {
    $type: "com.atproto.sync.subscribeRepos#commit";
    /** The stream sequence number of this message. */
    seq: number;
    /** Indicates that this commit contained too many ops, or data size was too large. Consumers will need to make a separate request to get missing data. */
    tooBig: boolean;
    /** The repo this event comes from. */
    repo: string;
    /** Repo commit object CID. */
    commit: CID;
    /** The rev of the emitted commit. Note that this information is also in the commit object included in blocks, unless this is a tooBig event. */
    rev: string;
    /** The rev of the last emitted commit from this repo (if any). */
    since: string | null;
    /** CAR file containing relevant blocks, as a diff since the previous repo state. */
    blocks: Uint8Array;
    /** List of repo mutation operations in this commit (eg, records created, updated, or deleted). */
    ops: Array<RepoOp>;
    /** List of new blobs (by CID) referenced by records in this commit. */
    blobs: CID[];
    /** Timestamp of when this message was originally broadcast. */
    time: string;
}
